<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Dashboard Solution</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 1200px; 
            margin: 50px auto; 
            padding: 20px; 
            background: #f9fafb;
        }
        .section { 
            margin-bottom: 20px; 
            padding: 20px; 
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .success { background: #d1fae5; border-left: 4px solid #10b981; }
        .error { background: #fee2e2; border-left: 4px solid #ef4444; }
        .info { background: #dbeafe; border-left: 4px solid #3b82f6; }
        .warning { background: #fef3c7; border-left: 4px solid #f59e0b; }
        button { 
            background: #4f46e5; 
            color: white; 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px;
            font-weight: 500;
        }
        button:hover { background: #4338ca; }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .live-demo {
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #e5e7eb;
        }
        .audience-view {
            background: #fef2f2;
            border: 2px solid #fecaca;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .creator-view {
            background: #f0f9ff;
            border: 2px solid #bae6fd;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="section success">
        <h1>🎯 LIVE DASHBOARD SOLUTION</h1>
        <p><strong>Perfect solution for live audience polling with hide/show results functionality!</strong></p>
    </div>
    
    <div class="section info">
        <h2>📋 Current Status</h2>
        <button onclick="checkCurrentState()">Check Current State</button>
        <div id="currentState" class="status info">Click to check current poll state</div>
    </div>
    
    <div class="section">
        <h2>🎮 Live Dashboard Control</h2>
        <button onclick="toggleResults()" id="toggleBtn">Toggle Show Results</button>
        <button onclick="setHidden()">Set Hidden (Default)</button>
        <button onclick="setVisible()">Set Visible</button>
        <div id="toggleStatus" class="status info">Ready to control live dashboard</div>
    </div>
    
    <div class="section">
        <h2>👥 Live Demo - Two Views</h2>
        
        <div class="creator-view">
            <h3>🎯 CREATOR VIEW (You)</h3>
            <p><strong>This is what you see as the poll creator:</strong></p>
            <div id="creatorView" class="live-demo">
                <p>Loading creator view...</p>
            </div>
        </div>
        
        <div class="audience-view">
            <h3>👥 AUDIENCE VIEW (Live Participants)</h3>
            <p><strong>This is what your audience sees:</strong></p>
            <div id="audienceView" class="live-demo">
                <p>Loading audience view...</p>
            </div>
        </div>
    </div>
    
    <div class="section">
        <h2>🔗 Test URLs</h2>
        <button onclick="openResultsPage()">Open Results Page (Creator)</button>
        <button onclick="openJoinPoll()">Open Join Poll (Audience)</button>
        <button onclick="openFixedResults()">Open Fixed Results Page</button>
        
        <div style="background: #f3f4f6; padding: 15px; border-radius: 6px; margin: 10px 0; font-family: monospace;">
            <strong>Creator Dashboard:</strong> http://localhost:3001/poll/U706KM/results-fixed<br>
            <strong>Audience Join:</strong> http://localhost:3001/poll/U706KM<br>
            <strong>Fixed Results:</strong> http://localhost:3001/poll/U706KM/results-fixed
        </div>
    </div>
    
    <div class="section warning">
        <h2>🎯 Perfect Live Polling Flow</h2>
        <ol>
            <li><strong>Start Poll:</strong> Results are hidden by default (showResults: false)</li>
            <li><strong>Audience Votes:</strong> They can vote but cannot see results</li>
            <li><strong>Show Results:</strong> Click "Show Results" when ready to reveal</li>
            <li><strong>Audience Sees:</strong> Results become visible to all participants</li>
            <li><strong>Hide Again:</strong> Click "Hide Results" to hide again if needed</li>
        </ol>
    </div>
    
    <script>
        let currentShowResults = null;
        let pollData = null;
        
        async function checkCurrentState() {
            try {
                const response = await fetch('http://localhost:3001/api/poll-results?code=U706KM');
                const data = await response.json();
                pollData = data.poll;
                currentShowResults = pollData.settings.showResults;
                
                const stateDiv = document.getElementById('currentState');
                stateDiv.className = 'status success';
                stateDiv.innerHTML = `
                    <strong>Current Poll State:</strong><br>
                    Title: ${pollData.title}<br>
                    Code: ${pollData.code}<br>
                    Show Results: ${currentShowResults}<br>
                    Participants: ${pollData.analytics.totalParticipants}<br>
                    Responses: ${pollData.analytics.totalResponses}
                `;
                
                updateViews();
                updateToggleButton();
                
            } catch (error) {
                document.getElementById('currentState').className = 'status error';
                document.getElementById('currentState').textContent = 'Error: ' + error.message;
            }
        }
        
        async function toggleResults() {
            if (currentShowResults === null) {
                alert('Please check current state first');
                return;
            }
            
            try {
                const statusDiv = document.getElementById('toggleStatus');
                statusDiv.className = 'status info';
                statusDiv.textContent = 'Toggling...';
                
                // Login
                const loginResponse = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@eventorg.com',
                        password: 'admin123'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.token;
                
                // Toggle
                const newValue = !currentShowResults;
                const updateResponse = await fetch('http://localhost:5000/api/polls/U706KM/settings', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        showResults: newValue
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Update failed');
                }
                
                currentShowResults = newValue;
                
                statusDiv.className = 'status success';
                statusDiv.textContent = `Successfully toggled to: ${newValue}`;
                
                updateViews();
                updateToggleButton();
                
            } catch (error) {
                document.getElementById('toggleStatus').className = 'status error';
                document.getElementById('toggleStatus').textContent = 'Error: ' + error.message;
            }
        }
        
        async function setHidden() {
            await setResultsState(false);
        }
        
        async function setVisible() {
            await setResultsState(true);
        }
        
        async function setResultsState(value) {
            try {
                const statusDiv = document.getElementById('toggleStatus');
                statusDiv.className = 'status info';
                statusDiv.textContent = `Setting to ${value}...`;
                
                // Login
                const loginResponse = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'admin@eventorg.com',
                        password: 'admin123'
                    })
                });
                
                if (!loginResponse.ok) {
                    throw new Error('Login failed');
                }
                
                const loginData = await loginResponse.json();
                const token = loginData.token;
                
                // Set state
                const updateResponse = await fetch('http://localhost:5000/api/polls/U706KM/settings', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        showResults: value
                    })
                });
                
                if (!updateResponse.ok) {
                    throw new Error('Update failed');
                }
                
                currentShowResults = value;
                
                statusDiv.className = 'status success';
                statusDiv.textContent = `Successfully set to: ${value}`;
                
                updateViews();
                updateToggleButton();
                
            } catch (error) {
                document.getElementById('toggleStatus').className = 'status error';
                document.getElementById('toggleStatus').textContent = 'Error: ' + error.message;
            }
        }
        
        function updateViews() {
            const creatorView = document.getElementById('creatorView');
            const audienceView = document.getElementById('audienceView');
            
            if (!pollData) {
                creatorView.innerHTML = '<p>No poll data loaded</p>';
                audienceView.innerHTML = '<p>No poll data loaded</p>';
                return;
            }
            
            // Creator View
            creatorView.innerHTML = `
                <h4>Poll: ${pollData.title}</h4>
                <p><strong>Status:</strong> ${currentShowResults ? 'Results Visible' : 'Results Hidden'}</p>
                <p><strong>Participants:</strong> ${pollData.analytics.totalParticipants}</p>
                <p><strong>Responses:</strong> ${pollData.analytics.totalResponses}</p>
                <p><strong>Control:</strong> You can show/hide results for your audience</p>
            `;
            
            // Audience View
            if (currentShowResults) {
                audienceView.innerHTML = `
                    <h4>Poll: ${pollData.title}</h4>
                    <p><strong>Status:</strong> ✅ Results are visible</p>
                    <p><strong>Participants:</strong> ${pollData.analytics.totalParticipants}</p>
                    <p><strong>Responses:</strong> ${pollData.analytics.totalResponses}</p>
                    <p><strong>View:</strong> Audience can see poll results and charts</p>
                `;
            } else {
                audienceView.innerHTML = `
                    <h4>Poll: ${pollData.title}</h4>
                    <p><strong>Status:</strong> ❌ Results are hidden</p>
                    <p><strong>Participants:</strong> ${pollData.analytics.totalParticipants}</p>
                    <p><strong>Responses:</strong> ${pollData.analytics.totalResponses}</p>
                    <p><strong>View:</strong> Audience can vote but cannot see results</p>
                `;
            }
        }
        
        function updateToggleButton() {
            const button = document.getElementById('toggleBtn');
            if (currentShowResults !== null) {
                button.textContent = currentShowResults ? 'Hide Results' : 'Show Results';
            }
        }
        
        function openResultsPage() {
            window.open('http://localhost:3001/poll/U706KM/results', '_blank');
        }
        
        function openJoinPoll() {
            window.open('http://localhost:3001/poll/U706KM', '_blank');
        }
        
        function openFixedResults() {
            window.open('http://localhost:3001/poll/U706KM/results-fixed', '_blank');
        }
        
        // Initialize
        checkCurrentState();
    </script>
</body>
</html>
